{"version":3,"sources":["db.es6"],"names":[],"mappings":"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","file":"db.js","sourcesContent":["\"use strict\";\n//require('source-map-support').install();\nvar Promise = require(\"bluebird\")\n/*Promise.config({\n longStackTraces: true\n })*/\nvar mysql = require('mysql');\n// Note that the library's classes are not properties of the main export\n// so we require and promisifyAll them manually\n//Promise.promisifyAll(require(\"mysql/lib/Connection\").prototype);\n//var mysql_pool = Promise.promisifyAll(require(\"mysql/lib/Pool\").prototype);\n//var mysql     =    require('mysql');\nvar db = {}\n\ndb.pool = mysql.createPool({\n    connectionLimit: 100, //important\n    host: 'localhost',\n    user: 'root',\n    password: 'rootXy',\n    database: 'oo',\n    debug: false\n});\nfunction handle_database(req, res) {\n\n    pool.getConnection(function (err, connection) {\n        if (err) {\n            connection.release();\n            res.json({\"code\": 100, \"status\": \"Error in connection database\"});\n            return;\n        }\n\n        console.log('connected as id ' + connection.threadId);\n\n        connection.query(\"select * from user\", function (err, rows) {\n            connection.release();\n            if (!err) {\n                res.json(rows);\n            }\n        });\n\n        connection.on('error', function (err) {\n            res.json({\"code\": 100, \"status\": \"Error in connection database\"});\n            return;\n        });\n    });\n}\n\nclass Connection {\n\n    constructor(conn) {\n        this.log_queries = true;\n        this.__conn__ = conn\n        this.beginTransaction = this.beginTransaction.bind(this)\n        this.commit = this.commit.bind(this)\n        this.rollback = this.rollback.bind(this)\n        this.busy = false;\n        return this;\n    }\n\n    async beginTransaction() {\n        var self = this;\n        return new Promise(function (resolve, reject) {\n            if (self.log_queries) console.log(\"BEGIN TRANSACTION\")\n            self.busy = true;\n            self.__conn__.beginTransaction(function (err) {\n                self.busy = false;\n                if (err) {\n                    reject(err);\n                    return;\n                }\n                resolve();\n            })\n        })\n    }\n\n    async query(sql, values) {\n        var self = this;\n        return new Promise(function (resolve, reject) {\n            if (self.log_queries) console.log(sql, values)\n            self.busy = true;\n            self.__conn__.query(sql, values, function (err, result, fields) {\n                self.busy = false;\n                if (err) {\n                    console.log(err)\n                    console.log(sql)\n                    console.log(values)\n                    reject(err);\n                    return;\n                }\n                if (fields != null) {//SELECTS por ejemplo\n                    resolve([result, fields]);\n                } else { //UPDATES POR EJEMPLO\n                    resolve(result)\n                }\n            })\n        })\n    }\n\n    async commit() {\n        var self = this;\n        return new Promise(function (resolve, reject) {\n            if (self.log_queries) console.log(\"COMMIT\")\n            self.busy = true;\n            self.__conn__.commit(function (err) {\n                self.busy = false;\n                if (err) {\n                    reject(err)\n                    return;\n                }\n                resolve();\n            })\n        })\n    }\n\n    async rollback() {\n        var self = this;\n        return new Promise(function (resolve, reject) {\n            if (self.log_queries) console.log(\"ROLLBACK\")\n            self.busy = true;\n            self.__conn__.rollback(function (err) {\n                self.busy = false;\n                if (err) {\n                    reject(err)\n                    return;\n                }\n                resolve();\n            })\n        })\n    }\n\n    release() {\n        console.log(\"RELEASING connnection\")\n        var self = this;\n        self.__conn__.release();\n        self.__conn__ = null;\n        //console.log(\"releasing connection\");\n    }\n}\n\ndb.getConnection = async function getConnection() {\n    console.log(\"REQUESTING NEW CONNECTION\")\n    return new Promise(function (resolve, reject) {\n        db.pool.getConnection(function (err, connection) {\n            if (err) {\n                if (connection) {\n                    connnection.release();\n                }\n                reject(err);\n                return;\n            }\n            //console.log(\"returning new connection\");\n            resolve(new Connection(connection));\n        })\n    })\n}\n\n\nmodule.exports = db;\n\n"]}