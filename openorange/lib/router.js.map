{"version":3,"sources":["router.es6"],"names":[],"mappings":"AAAA;;AAEA,IAAI,UAAU,QAAQ,SAAR,CAAd;AACA,IAAI,SAAS,QAAQ,MAAR,EAAb;AACA,IAAI,KAAK,QAAQ,IAAR,CAAT;AACA,IAAI,KAAK,QAAQ,YAAR,CAAT;AACA,IAAI,KAAK,GAAG,YAAZ;AACA,IAAI,MAAM,QAAQ,OAAR,CAAV;AACA,IAAI,SAAS,GAAG,QAAH,CAAY,iBAAZ,CAAb;AACA,IAAI,OAAO,QAAQ,MAAR,CAAX;AACA,IAAI,IAAI,QAAQ,YAAR,CAAR;;;AAIA,KAAK,IAAI,IAAE,CAAX,EAAa,IAAE,GAAG,mBAAH,CAAuB,MAAtC,EAA6C,GAA7C,EAAiD;;AAE7C,QAAI,KAAK,GAAG,mBAAH,CAAuB,CAAvB,CAAT;AACA,WAAO,GAAP,CAAW,cAAY,EAAvB,EAA2B,QAAQ,MAAR,CAAe,KAAK,IAAL,CAAU,SAAV,EAAqB,OAArB,EAA8B,EAA9B,CAAf,CAA3B;AACH;AACD,OAAO,GAAP,CAAW,GAAX,EAAgB,GAAG,cAAH,CAAkB,iBAAlB,EAAhB,E;;AAEA,OAAO,GAAP,CAAW,aAAX,EAA0B,QAAQ,MAAR,CAAe,KAAK,IAAL,CAAU,SAAV,EAAqB,QAArB,CAAf,CAA1B;AACA,OAAO,GAAP,CAAW,WAAX,EAAwB,QAAQ,MAAR,CAAe,KAAK,IAAL,CAAU,SAAV,EAAqB,MAArB,CAAf,CAAxB;;AAEA,SAAS,qBAAT,CAA+B,EAA/B,EAAmC;AAC/B,SAAK,IAAI,CAAT,IAAc,GAAG,mBAAjB,EAAsC;AAClC,YAAI,KAAK,GAAG,mBAAH,CAAuB,CAAvB,CAAT;AACA,YAAI,MAAM,GAAG,WAAH,CAAe,MAAI,EAAJ,GAAO,GAAtB,CAAV;AACA,YAAI,OAAO,CAAX,EAAc;AACV,mBAAO,GAAG,SAAH,CAAa,GAAb,CAAP;AACH;AACJ;AACD,WAAO,IAAP;AACH;;AAED,SAAS,UAAT,CAAoB,GAApB,EAAyB,GAAzB,EAA8B,EAA9B,EAAkC;AAC9B,OAAG,QAAH,CAAY,EAAZ,EAAgB,MAAhB,EAAwB,UAAU,GAAV,EAAe,IAAf,EAAqB;AACzC,YAAI,GAAJ,EAAS;AACL,mBAAO,QAAQ,GAAR,CAAY,GAAZ,CAAP;AACH;AACD,YAAI,cAAc,sBAAsB,EAAtB,CAAlB;AACA,YAAI,WAAW,kDAAf;AACA,mBAAW,WAAW,mBAAX,GAAiC,KAAK,OAAL,CAAa,WAAb,CAAjC,GAA6D,MAAxE;AACA,mBAAW,WAAW,oBAAX,GAAkC,WAAlC,GAAgD,MAA3D;AACA,mBAAW,WAAW,IAAX,GAAkB,8BAA7B;AACA,mBAAW,gCAA6B,IAAI,OAAjC,gBAAmD,WAAnD,CAAX;;AAEA,YAAI,MAAJ,CAAW,GAAX,EAAgB,IAAhB,CAAqB,QAArB;AACH,KAZD;AAaH;;AAED,OAAO,IAAP,CAAY,iBAAZ,EAA+B,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AACrD,QAAI,SAAS,IAAI,IAAjB;AACA,QAAI,GAAJ;AACA,QAAI,OAAO,QAAP,IAAmB,UAAvB,EAAmC;AAC/B,cAAM,OAAO,QAAP,CAAgB,OAAO,IAAvB,CAAN;AACH,KAFD,MAEO;AACH,cAAM,GAAG,QAAH,CAAY,OAAO,WAAnB,CAAN;AACH;AACD,QAAI,SAAJ,CAAc,cAAd,EAA8B,kBAA9B;AACA,QAAI,OAAO,MAAX,EAAmB,KAAnB,CAAyB,GAAzB,EAA8B,OAAO,MAArC,EACK,IADL,CACU,UAAU,QAAV,EAAoB;AACtB,YAAI,OAAO,QAAP,IAAmB,UAAvB,EAAmC;AAC/B,gBAAI,IAAJ,CAAS,EAAC,IAAI,IAAL,EAAW,MAAM,KAAK,SAAL,CAAe,GAAf,CAAjB,EAAsC,UAAU,QAAhD,EAAT;AACH,SAFD,MAEO;AACH,gBAAI,IAAJ,CAAS,EAAC,IAAI,IAAL,EAAW,UAAU,QAArB,EAAT;AACH;AACJ,KAPL,EAQK,KARL,CAQW,UAAU,GAAV,EAAe;AAClB,YAAI,IAAJ,CAAS,EAAC,IAAI,KAAL,EAAY,OAAO,GAAnB,EAAT;AACA,gBAAQ,GAAR,CAAY,GAAZ;AACH,KAXL;AAYH,CArBD;;AAuBA,OAAO,IAAP,CAAY,cAAZ,EAA4B,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AAClD,QAAI,SAAS,IAAI,IAAjB;AACA,QAAI,SAAJ,CAAc,cAAd,EAA8B,kBAA9B;AACA,QAAI,QAAQ,GAAG,KAAH,CAAS,QAAT,CAAkB,IAAI,IAAtB,CAAZ;;AAEA,UAAM,KAAN,GACK,IADL,CACU,UAAU,QAAV,EAAoB;AACtB,YAAI,IAAJ,CAAS,EAAC,IAAI,IAAL,EAAW,UAAU,QAArB,EAAT;AACH,KAHL,EAIK,KAJL,CAIW,UAAU,GAAV,EAAe;AAClB,YAAI,IAAJ,CAAS,EAAC,IAAI,KAAL,EAAY,OAAO,GAAnB,EAAT;AACA,gBAAQ,GAAR,CAAY,IAAI,KAAhB;AACH,KAPL;AAQH,CAbD;;AAgBA,OAAO,GAAP,CAAW,QAAX,EAAqB,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AAC3C,QAAI;AACA,YAAI,MAAM,GAAG,QAAH,CAAY,IAAI,KAAJ,CAAU,IAAtB,EAA4B,IAAI,KAAJ,CAAU,oBAAtC,CAAV;AACA,YAAI,KAAK,IAAI,eAAJ,CAAoB,QAApB,IAAgC,IAAI,YAA7C;AACA,mBAAW,GAAX,EAAgB,GAAhB,EAAqB,EAArB;AACH,KAJD,CAIE,OAAO,GAAP,EAAY;AACV,gBAAQ,GAAR,CAAY,IAAI,KAAhB;AACA,cAAM,GAAN;AACH;AACJ,CATD;;AAWA,OAAO,GAAP,CAAW,cAAX,EAA2B,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AACjD,QAAI;AACA,YAAI,MAAM,GAAG,iBAAH,CAAqB,IAAI,KAAJ,CAAU,IAA/B,EAAqC,IAAI,KAAJ,CAAU,MAA/C,EAAuD,IAAI,KAAJ,CAAU,OAAjE,CAAV;AACA,YAAI,KAAK,IAAI,eAAJ,CAAoB,QAApB,IAAgC,IAAI,YAA7C;AACA,mBAAW,GAAX,EAAgB,GAAhB,EAAqB,EAArB;;AAEH,KALD,CAKE,OAAO,GAAP,EAAY;AACV,gBAAQ,GAAR,CAAY,IAAI,KAAhB;AACA,cAAM,GAAN;AACH;AACJ,CAVD;;AAYA,OAAO,GAAP,CAAW,SAAX,EAAsB,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AAC5C,QAAI,KAAK,IAAI,KAAJ,CAAU,GAAV,GAAgB,KAAzB;AACA,eAAW,GAAX,EAAgB,GAAhB,EAAqB,EAArB;AACH,CAHD;;AAKA,OAAO,GAAP,CAAW,SAAX,EAAsB,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AAC5C,QAAI,aAAa,UAAjB;AACA,QAAI,WAAW,GAAG,QAAH,CAAY,UAAZ,CAAf;AACA,aAAS,MAAT,GACK,IADL,CACU,UAAU,OAAV,EAAmB;AACrB,YAAI,IAAJ,CAAS;AACL,gBAAI,IADC,EACK,SAAS,EAAE,OAAF,EAAW,GAAX,CAAe,UAAU,GAAV,EAAe;AAC7C,uBAAO,KAAK,SAAL,CAAe,GAAf,CAAP;AACH,aAFkB;AADd,SAAT;AAKH,KAPL,EAQK,KARL,CAQW,UAAU,GAAV,EAAe;AAClB,gBAAQ,GAAR,CAAY,GAAZ;AACA,YAAI,IAAJ,CAAS,EAAC,IAAI,KAAL,EAAY,OAAO,GAAnB,EAAT;AACH,KAXL;AAYH,CAfD;;AAiBA,OAAO,GAAP,CAAW,kBAAX,EAA+B,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;;AAErD,OAAG,QAAH,CAAY,MAAZ,CAAmB,IAAI,KAAJ,CAAU,GAA7B,EACK,IADL,CACU,UAAU,MAAV,EAAkB;AACpB,YAAI,IAAJ,CAAS,EAAC,IAAI,IAAL,EAAW,UAAU,MAArB,EAAT;AACH,KAHL,EAIK,KAJL,CAIW,UAAU,GAAV,EAAe;AAClB,gBAAQ,GAAR,CAAY,IAAI,KAAhB;AACA,YAAI,IAAJ,CAAS,EAAC,IAAI,KAAL,EAAY,OAAO,GAAnB,EAAT;AACH,KAPL;AAQH,CAVD;;;;;;;;;;;AAsBA,OAAO,GAAP,CAAW,iBAAX,EAA8B,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AACpD,QAAI,IAAJ,CAAS,EAAC,IAAI,IAAL,EAAW,aAAa,IAAI,OAAJ,CAAY,IAApC,EAAT;AACH,CAFD;;AAIA,OAAO,IAAP,CAAY,QAAZ,EAAsB,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AAC5C,YAAQ,GAAR,CAAY,IAAI,IAAhB;AACA,YAAQ,GAAR,CAAY,cAAZ,EAA4B,IAAI,IAAJ,CAAS,QAArC;AACA,QAAI;AACA,WAAG,KAAH,CAAS,IAAI,IAAJ,CAAS,QAAlB,EAA4B,IAAI,IAAJ,CAAS,OAArC,EACK,IADL,CACU,UAAU,KAAV,EAAiB;AACnB,oBAAQ,GAAR,CAAY,SAAZ;AACA,gBAAI,KAAJ,EAAW;AACP,wBAAQ,GAAR,CAAY,YAAZ;AACA,oBAAI,OAAJ,CAAY,IAAZ,GAAmB,IAAI,IAAJ,CAAS,QAA5B;AACA,oBAAI,IAAI,IAAJ,CAAS,mBAAb,EAAkC;AAC9B,wBAAI,QAAJ,CAAa,IAAI,IAAJ,CAAS,mBAAtB;AACH,iBAFD,MAEO;AACH,wBAAI,IAAJ,CAAS,EAAC,IAAI,IAAL,EAAT;AACH;AAGJ,aAVD,MAUO;AACH,wBAAQ,GAAR,CAAY,gBAAZ;AACA,oBAAI,IAAJ,CAAS,EAAC,IAAI,KAAL,EAAY,OAAO,wBAAnB,EAAT;AACH;AACJ,SAjBL,EAkBK,KAlBL,CAkBW,UAAU,GAAV,EAAe;AAClB,oBAAQ,GAAR,CAAY,KAAZ;AACA,oBAAQ,GAAR,CAAY,IAAI,KAAhB;AACH,SArBL;AAsBH,KAvBD,CAuBE,OAAO,GAAP,EAAY;AACV,gBAAQ,GAAR,CAAY,IAAI,KAAhB;AACH;AACJ,CA7BD;;AA+BA,OAAO,IAAP,CAAY,cAAZ,EAA4B,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AAClD,OAAG,QAAH,GACK,IADL,CACU,UAAU,MAAV,EAAkB;AACpB,YAAI,IAAJ,CAAS,EAAC,IAAI,IAAL,EAAW,UAAU,MAArB,EAAT;AACH,KAHL,EAIK,KAJL,CAIW,UAAU,GAAV,EAAe;AAClB,gBAAQ,GAAR,CAAY,GAAZ;AACA,YAAI,IAAJ,CAAS,EAAC,IAAI,KAAL,EAAY,OAAO,GAAnB,EAAT;AACH,KAPL;AAQH,CATD;;AAWA,OAAO,IAAP,CAAY,YAAZ,EAA0B,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AAChD,OAAG,MAAH,GACK,IADL,CACU,UAAU,MAAV,EAAkB;AACpB,YAAI,IAAJ,CAAS,EAAC,IAAI,IAAL,EAAW,UAAU,MAArB,EAAT;AACH,KAHL,EAIK,KAJL,CAIW,UAAU,GAAV,EAAe;AAClB,gBAAQ,GAAR,CAAY,GAAZ;AACA,YAAI,IAAJ,CAAS,EAAC,IAAI,KAAL,EAAY,OAAO,GAAnB,EAAT;AACH,KAPL;AAQH,CATD;;AAWA,OAAO,IAAP,CAAY,sBAAZ,EAAoC,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AAC1D,OAAG,gBAAH,GACK,IADL,CACU,UAAU,MAAV,EAAkB;AACpB,YAAI,IAAJ,CAAS,EAAC,IAAI,IAAL,EAAW,UAAU,MAArB,EAAT;AACH,KAHL,EAIK,KAJL,CAIW,UAAU,GAAV,EAAe;AAClB,gBAAQ,GAAR,CAAY,GAAZ;AACA,YAAI,IAAJ,CAAS,EAAC,IAAI,KAAL,EAAY,OAAO,GAAnB,EAAT;AACH,KAPL;AAQH,CATD;AAUA,OAAO,OAAP,GAAiB,MAAjB","file":"router.js","sourcesContent":["\"use strict\";\n\nvar express = require('express');\nvar router = express.Router();\nvar fs = require(\"fs\")\nvar oo = require('openorange')\nvar cm = oo.classmanager\nvar orm = require('./orm')\nvar Record = cm.getClass(\"Embedded_Record\")\nvar path = require(\"path\")\nvar _ = require('underscore')\n//var babel = require(\"babel-core\")\n\n\nfor (let i=0;i<cm.reversed_scriptdirs.length;i++){\n    //esto es xq el navegador pide los archivos .map.js para debugging por consola\n    let sd = cm.reversed_scriptdirs[i];\n    router.use('/sources/'+sd, express.static(path.join(__dirname, '../..', sd )));\n}\nrouter.use('/', oo.contextmanager.expressMiddleware()); //aca manejan usuario actual, conexion actual, etc. para ser usadas con toda la app. Son variables definidas por request/cookie\n\nrouter.use('/lib/client', express.static(path.join(__dirname, 'client')));\nrouter.use('/lib/both', express.static(path.join(__dirname, 'both')));\n\nfunction extractSDRelativePath(fn) {\n    for (var i in cm.reversed_scriptdirs) {\n        var sd = cm.reversed_scriptdirs[i];\n        var idx = fn.lastIndexOf(\"/\"+sd+\"/\")\n        if (idx >= 0) {\n            return fn.substring(idx);\n        }\n    }\n    return null;\n}\n\nfunction sendModule(req, res, fn) {\n    fs.readFile(fn, 'utf8', function (err, data) {\n        if (err) {\n            return console.log(err);\n        }\n        let relative_fn = extractSDRelativePath(fn);\n        var fulldata = \"var moduleFunction = (function() {module = {};\\n\";\n        fulldata = fulldata + \"var __dirname = '\" + path.dirname(relative_fn) + \"';\\n\"\n        fulldata = fulldata + \"var __filename = '\" + relative_fn + \"';\\n\"\n        fulldata = fulldata + data + \"\\nreturn module.exports;})\\n\";\n        fulldata = fulldata + `//# sourceURL= ${req.baseUrl}/sources${relative_fn}`;\n        //fulldata = babel.transform(fulldata, {\"presets\": [\"stage-3\"]}).code\n        res.status(200).send(fulldata);\n    });\n}\n\nrouter.post('/record/:method', function (req, res, next) {\n    var params = req.body;\n    var rec;\n    if (params.calltype == 'instance') {\n        rec = Record.fromJSON(params.self)\n    } else {\n        rec = cm.getClass(params.recordclass);\n    }\n    res.setHeader('Content-Type', 'application/json');\n    rec[params.method].apply(rec, params.params)\n        .then(function (response) {\n            if (params.calltype == 'instance') {\n                res.send({ok: true, self: JSON.stringify(rec), response: response});\n            } else {\n                res.send({ok: true, response: response});\n            }\n        })\n        .catch(function (err) {\n            res.send({ok: false, error: err})\n            console.log(err)\n        });\n});\n\nrouter.post('/query/fetch', function (req, res, next) {\n    var params = req.body;\n    res.setHeader('Content-Type', 'application/json');\n    var query = oo.query.fromJSON(req.body);\n    //console.log(req.body)\n    query.fetch()\n        .then(function (response) {\n            res.send({ok: true, response: response});\n        })\n        .catch(function (err) {\n            res.send({ok: false, error: err})\n            console.log(err.stack)\n        });\n});\n\n\nrouter.get('/class', function (req, res, next) {\n    try {\n        var cls = cm.getClass(req.query.name, req.query.max_script_dir_index);\n        var fn = cls.__description__.filename || cls.__filename__;\n        sendModule(req, res, fn);\n    } catch (err) {\n        console.log(err.stack);\n        throw err;\n    }\n});\n\nrouter.get('/parentclass', function (req, res, next) {\n    try {\n        var cls = cm.getParentClassFor(req.query.name, req.query.parent, req.query.dirname)\n        var fn = cls.__description__.filename || cls.__filename__;\n        sendModule(req, res, fn);\n        //console.log(fn)\n    } catch (err) {\n        console.log(err.stack);\n        throw err;\n    }\n});\n\nrouter.get('/module', function (req, res, next) {\n    var fn = req.query.url + \".js\"\n    sendModule(req, res, fn);\n});\n\nrouter.get('/select', function (req, res, next) {\n    var recordname = 'Customer'\n    var recClass = cm.getClass(recordname);\n    recClass.select()\n        .then(function (records) {\n            res.send({\n                ok: true, records: _(records).map(function (rec) {\n                    return JSON.stringify(rec)\n                })\n            });\n        })\n        .catch(function (err) {\n            console.log(err)\n            res.send({ok: false, error: err})\n        });\n});\n\nrouter.get('/explorer/search', function (req, res, next) {\n    //console.log(req.query.txt)\n    oo.explorer.search(req.query.txt)\n        .then(function (result) {\n            res.send({ok: true, response: result});\n        })\n        .catch(function (err) {\n            console.log(err.stack)\n            res.send({ok: false, error: err})\n        });\n});\n\n\n/*\n router.post('/login', function (req, res, next) {\n let data = req.body;\n console.log(\"login user: \", data)\n req.session.user = data.user\n res.send({ok: true})\n });\n */\n\nrouter.get('/getcurrentuser', function (req, res, next) {\n    res.send({ok: true, currentuser: req.session.user})\n});\n\nrouter.post('/login', function (req, res, next) {\n    console.log(req.body)\n    console.log(\"login user: \", req.body.username)\n    try {\n        oo.login(req.body.username, req.body.md5pass)\n            .then(function (found) {\n                console.log(\"en then\")\n                if (found) {\n                    console.log(\"user found\")\n                    req.session.user = req.body.username\n                    if (req.body.redirect_on_success) {\n                        res.redirect(req.body.redirect_on_success)\n                    } else {\n                        res.send({ok: true})\n                    }\n\n\n                } else {\n                    console.log(\"user not found\")\n                    res.send({ok: false, error: 'wrong user or password'})\n                }\n            })\n            .catch(function (err) {\n                console.log(\"ERR\")\n                console.log(err.stack)\n            });\n    } catch (err) {\n        console.log(err.stack)\n    }\n});\n\nrouter.post('/oo/rollback', function (req, res, next) {\n    oo.rollback()\n        .then(function (result) {\n            res.send({ok: true, response: result});\n        })\n        .catch(function (err) {\n            console.log(err)\n            res.send({ok: false, error: err})\n        });\n});\n\nrouter.post('/oo/commit', function (req, res, next) {\n    oo.commit()\n        .then(function (result) {\n            res.send({ok: true, response: result});\n        })\n        .catch(function (err) {\n            console.log(err)\n            res.send({ok: false, error: err})\n        });\n});\n\nrouter.post('/oo/begintransaction', function (req, res, next) {\n    oo.beginTransaction()\n        .then(function (result) {\n            res.send({ok: true, response: result});\n        })\n        .catch(function (err) {\n            console.log(err)\n            res.send({ok: false, error: err})\n        });\n});\nmodule.exports = router;"]}