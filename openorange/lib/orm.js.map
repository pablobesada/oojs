{"version":3,"sources":["../../node_modules/openorange/lib/orm.es6"],"names":[],"mappings":"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","file":"orm.js","sourcesContent":["\"use strict\";\nvar db = require(\"./db\")\nvar async = require(\"async\")\nvar Promise = require(\"bluebird\")\nvar ormutils = require(\"./ormutils.js\")\nvar Query = require(\"./serverquery.js\")\n\nPromise.config({\n    longStackTraces: true\n})\nvar orm = {}\n\nfunction raw_insert_row_function(connection, record) {\n    var insert = orm.generate_insert_sql(record);\n    //console.log(insert.sql)\n    return connection.query(insert.sql, insert.values)\n        .then(function (info) {\n            record.internalId = info.insertId;\n            record.syncVersion = 1;\n            record.setNewFlag(false);\n            record.setModifiedFlag(false);\n        })\n}\n\nfunction raw_delete_row_function(connection, record) {\n    var del = orm.generate_delete_sql(record);\n    //console.log(del.sql)\n    //console.log(del.values)\n    return connection.query(del.sql, del.values)\n        .then(function (info) {\n            if (info.affectedRows != 1) {\n                throw {code: \"ROW_NOT_DELETED\", message: \"Row couldn't be deleted\"}\n                return;\n            }\n        })\n}\n\nfunction raw_update_row_function(connection, record) {\n    var update = orm.generate_update_sql(record);\n    //console.log(update.sql)\n    return connection.query(update.sql, update.values)\n        .then(function (info) {\n            if (info.changedRows != 1) {\n                throw {code: \"ROW_NOT_UPDATED\", message: \"Row couldn't be updated\"}\n            } else {\n                record.setNewFlag(false);\n                record.setModifiedFlag(false);\n            }\n        })\n}\n\nfunction deleteDetailFunction(connection, record, detailname) {\n    var detail = record.details(detailname);\n    var del = orm.generate_delete_detail_sql(record, detailname);\n    //console.log(del.sql)\n    //console.log(del.values)\n    return connection.query(del.sql, del.values)\n}\n\nfunction saveDetailFunction(connection, record, detailname) {\n    var funcs = [];\n    return new Promise(function (resolve, reject) {\n        var detail = record.details(detailname);\n        for (var i = 0; i < detail.length; i++) {\n            var row = detail[i];\n            row.masterId = record.internalId;\n            row.rowNr = i;\n            if (row.isModified()) {\n                if (row.isNew()) {\n                    funcs.push(raw_insert_row_function(connection, row))\n                } else {\n                    funcs.push(raw_update_row_function(connection, row))\n                }\n            }\n        }\n        for (var i = 0; i < detail.__removed_rows__.length; i++) {\n            var row = detail.__removed_rows__[i];\n            if (!row.isNew()) {\n                funcs.push(raw_delete_row_function(connection, row))\n            }\n        }\n        resolve();\n    })\n        .then(function () {\n            return Promise.all(funcs)\n        })\n}\n\norm.generate_insert_sql = function generate_insert_sql(record) {\n    var fieldnames = record.fieldNames();\n    var questions = [];\n    var values = [];\n    var fnames = []\n\n    for (var i = 0; i < fieldnames.length; i++) {\n        var fn = fieldnames[i];\n        if (fn == 'internalId') continue;\n        fnames.push(\"`\" + fn + \"`\");\n        questions.push(\"?\");\n        if (fn == 'syncVersion') {\n            values.push(1);\n        } else {\n            values.push(record.fields(fn).getSQLValue());\n        }\n    }\n    var sql = \"INSERT INTO \" + record.__description__.name + \" (\" + fnames.join(\",\") + \") VALUES (\" + questions.join(\",\") + \")\";\n    return {sql: sql, values: values};\n}\n\norm.generate_update_sql = function generate_update_sql(record) {\n    var fieldnames = record.fieldNames();\n    var values = [];\n    var setfields = [];\n    var where = [];\n    for (var i = 0; i < fieldnames.length; i++) {\n        var fn = fieldnames[i];\n        setfields.push(\"`\" + fn + \"`=?\");\n        if (fn == 'syncVersion') {\n            values.push(record[fn] + 1);\n        } else {\n            values.push(record.fields(fn).getSQLValue());\n        }\n    }\n    where.push(\"`internalId`=?\");\n    values.push(record.oldFields(\"internalId\").getSQLValue());\n    if (record.hasField(\"syncVersion\")) {\n        where.push(\"`syncVersion`=?\");\n        values.push(record.oldFields(\"syncVersion\").getSQLValue());\n    }\n    var sql = \"UPDATE \" + record.__description__.name + \" SET \" + setfields.join(\",\") + \" WHERE \" + where.join(\" AND \");\n    return {sql: sql, values: values};\n}\n\norm.generate_delete_sql = function generate_update_sql(record) {\n    var values = [];\n    var where = [];\n    where.push(\"`internalId`=?\");\n    values.push(record.internalId);\n    if (record.hasField(\"syncVersion\")) {\n        where.push(\"`syncVersion`=?\");\n        values.push(record.syncVersion);\n    }\n    var sql = \"DELETE FROM \" + record.__description__.name + \" WHERE \" + where.join(\" AND \");\n    return {sql: sql, values: values};\n}\n\norm.generate_delete_detail_sql = function generate_update_sql(record, detailname) {\n    var values = [];\n    var where = [];\n    where.push(\"`masterId`=?\");\n    values.push(record.internalId);\n    var sql = \"DELETE FROM \" + record.details(detailname).__description__.class + \" WHERE \" + where.join(\" AND \");\n    return {sql: sql, values: values};\n}\n\nfunction select_detail_function2(conn, record, dn) {\n    return function (cb) {\n        var select = orm.generate_select_detail_sql(record, dn);\n        //console.log(select.sql)\n        var detail = record.details(dn);\n        conn.query(select.sql, select.values, function (err, rows, fields) {\n            if (err) {\n                cb(err);\n                return;\n            }\n            rows.forEach(function (row) {\n                var rw = detail.newRow();\n                ormutils.fill_record_with_query_result(rw, row, fields);\n                detail.push(rw);\n                rw.setNewFlag(false);\n                rw.setModifiedFlag(false);\n            })\n            cb(null);\n            return;\n        })\n    }\n}\n\nfunction select_detail_function(conn, record, dn) {\n    var select = orm.generate_select_detail_sql(record, dn);\n    //console.log(select.sql)\n    var detail = record.details(dn);\n    return conn.query(select.sql, select.values)\n        .spread(function (rows, fields) {\n            rows.forEach(function (row) {\n                var rw = detail.newRow();\n                ormutils.fill_record_with_query_result(rw, row, fields);\n                detail.push(rw);\n                rw.setNewFlag(false);\n                rw.setModifiedFlag(false);\n            })\n        })\n}\n\norm.load2 = function load(record, callback) {\n    var conn = null;\n    async.series([\n            function (cb) {\n                db.pool.getConnection(function (err, val) {\n                    conn = val;\n                    if (err && conn) conn.release();\n                    cb(err);\n                });\n            },\n            function (cb) {\n                var select = orm.generate_load_sql(record);\n                //console.log(select.sql)\n                conn.query(select.sql, select.values, function (err, rows, fields) {\n                    if (err) {\n                        cb(err);\n                        return;\n                    }\n                    if (rows == 0) {\n                        cb({error: \"record not found\"})\n                        return;\n                    }\n                    ormutils.fill_record_with_query_result(record, rows[0], fields)\n                    record.setNewFlag(false);\n                    record.setModifiedFlag(false);\n                    cb(null);\n                    return;\n                })\n            },\n            function (cb) {\n                var funcs = [];\n                record.detailNames().forEach(function (dn) {\n                    funcs.push(select_detail_function(conn, record, dn))\n                })\n                async.parallel(funcs,\n                    function result(err, results) {\n                        cb(err);\n                    }\n                )\n            }],\n        function result(err, results) {\n            if (conn) conn.release();\n            callback(err);\n        }\n    );\n}\n\norm.load = async function load(record) {\n    try {\n        var conn = await db.getConnection()\n        var select = orm.generate_load_sql(record);\n        //console.log(select.sql)\n        var qres = await conn.query(select.sql, select.values);\n        var rows = qres[0], fields = qres[1];\n        if (rows == 0) {\n            return false;\n        }\n        ormutils.fill_record_with_query_result(record, rows[0], fields)\n        record.setNewFlag(false);\n        record.setModifiedFlag(false);\n\n        var funcs = [];\n        record.detailNames().forEach(function (dn) {\n            funcs.push(select_detail_function(conn, record, dn))\n        })\n        await Promise.all(funcs);\n        conn.release();\n        conn = null;\n        record.syncOldFields();\n        return true;\n    } finally {\n        if (conn != null) {\n            conn.release()\n            conn = null;\n            //console.log(err, conn)\n        }\n    }\n}\n\norm.generate_load_sql = function generate_load_sql(record) {\n    var fieldnames = record.fieldNames();\n    var questions = [];\n    var values = [];\n    var snames = []\n    var where = []\n\n    for (var i = 0; i < fieldnames.length; i++) {\n        var fn = fieldnames[i];\n        snames.push(\"`\" + fn + \"`\");\n        var value = record[fn];\n        if (value != null) {\n            where.push(\"`\" + fn + \"` = ?\");\n            values.push(record[fn]);\n        }\n    }\n    if (where.length == 0) throw new Error(\"Imposible hacer select sin valores\")\n    var sql = \"SELECT \" + snames.join(\",\") + \" FROM \" + record.__description__.name + \" WHERE \" + where.join(\" AND \") + \" LIMIT 1\";\n    return {sql: sql, values: values};\n}\n\norm.generate_select_detail_sql = function generate_select_detail_sql(record, detailname) {\n    var detail = record.details(detailname);\n    var fieldnames = detail.fieldNames();\n    var questions = [];\n    var values = [record.internalId];\n    var snames = []\n    var where = \"`masterId`=?\";\n    var order = \"rowNr ASC\";\n\n    for (var i = 0; i < fieldnames.length; i++) {\n        var fn = fieldnames[i];\n        snames.push(\"`\" + fn + \"`\");\n    }\n    var sql = \"SELECT \" + snames.join(\",\") + \" FROM \" + detail.__description__.class + \" WHERE \" + where + \" ORDER BY \" + order;\n    return {sql: sql, values: values};\n}\n\nfunction finish_parallel_function(conn, record, callback) {\n    return function result(err, result) {\n        if (err) {\n            conn.rollback(function (err2) {\n                conn.release();\n                if (err2) {\n                    callback(err2);\n                    return;\n                } //no estoy seguro de esto\n                callback(err);\n                return;\n            });\n        } else {\n            conn.commit(function (err2) {\n                conn.release();\n                if (err2) {\n                    callback(err2); //no estoy seguro de esto\n                    return;\n                }\n                record.__clearRemovedRows__();\n                callback(null);\n                return;\n            });\n        }\n    }\n}\n\nfunction finish_parallel_function(conn, record, callback) {\n    return function result(err, result) {\n        if (err) {\n            conn.rollback(function (err2) {\n                conn.release();\n                if (err2) {\n                    callback(err2);\n                    return;\n                } //no estoy seguro de esto\n                callback(err);\n                return;\n            });\n        } else {\n            conn.commit(function (err2) {\n                conn.release();\n                if (err2) {\n                    callback(err2); //no estoy seguro de esto\n                    return;\n                }\n                record.__clearRemovedRows__();\n                callback(null);\n                return;\n            });\n        }\n    }\n}\n\nfunction commit(conn, record) {\n    return conn.commit()\n        .then(function () {\n            record.__clearRemovedRows__();\n        })\n}\n\n\nfunction rollback(conn, record) {\n    return conn.rollback();\n}\n\nfunction save_details_and_finish_function2(conn, record, callback) {\n    return function result(err, result) {\n        if (err) {\n            conn.rollback(function (err2) {\n                conn.release();\n                if (err2) {\n                    callback(err2);\n                    return;\n                } //no estoy seguro de esto\n                callback(err);\n                return;\n            });\n            return;\n        }\n        var funcs = [];\n        for (var i = 0; i < record.detailNames().length; i++) {\n            var f = saveDetailFunction(conn, record, record.detailNames()[i]);\n            funcs.push(f);\n        }\n        async.parallel(funcs, finish_parallel_function(conn, record, callback));\n    }\n}\n\nasync function save_details_and_finish_function(conn, record) {\n    try {\n        var funcs = [];\n        await new Promise(function (resolve, reject) {\n            for (var i = 0; i < record.detailNames().length; i++) {\n                var f = saveDetailFunction(conn, record, record.detailNames()[i]);\n                funcs.push(f);\n            }\n            resolve()\n        });\n        await Promise.all(funcs);\n        await conn.commit();\n        return true;\n    } catch (err) {\n        await conn.rollback(conn);\n        return false;\n    }\n}\n\n\nasync function save_new(conn, record) {\n    await conn.beginTransaction()\n    var insert = orm.generate_insert_sql(record);\n    var info = await conn.query(insert.sql, insert.values)\n    record.internalId = info.insertId;\n    record.syncVersion = 1;\n    record.setNewFlag(false);\n    record.setModifiedFlag(false);\n    return save_details_and_finish_function(conn, record)\n}\n\nasync function save_existing(conn, record) {\n    await conn.beginTransaction();\n    let update = orm.generate_update_sql(record);\n    let info = await conn.query(update.sql, update.values)\n    if (info.changedRows != 1) {\n        console.log({code: \"WRONG_SYNCVERSION\", message: \"Record might have been modified by other user \" + info.changedRows})\n        return false\n    }\n    record.syncVersion += 1;\n    record.setNewFlag(false);\n    record.setModifiedFlag(false);\n    return save_details_and_finish_function(conn, record);\n}\n\nfunction delete_details_and_finish_function(conn, record) {\n    var funcs = [];\n    return new Promise(function (resolve, reject) {\n        for (var i = 0; i < record.detailNames().length; i++) {\n            var f = deleteDetailFunction(conn, record, record.detailNames()[i]);\n            funcs.push(f);\n        }\n        resolve();\n    })\n    .then(function () {\n        return Promise.all(funcs)\n    })\n    .then(\n        function () {\n            return conn.commit().then(function () {\n                record.syncOldFields()\n            })\n        },\n        function onReject(err) {\n            return rollback(conn, record).then(Promise.reject(err));\n        }\n    )\n}\n\norm.store = async function store(record, callback) {\n    let res = true;\n    if (!record.isNew() && !record.isModified()) {\n        return true;\n    }\n    try {\n        var conn = await db.getConnection();\n        if (record.isNew()) {\n            let res = await save_new(conn, record);\n        } else if (record.isModified()) {\n            let res = await save_existing(conn, record);\n            if (!res) return res;\n        }\n        record.syncOldFields();\n    } finally {\n        if (conn != null) {\n            conn.release()\n            conn = null;\n        }\n    };\n    return true;\n}\n\norm.delete = function (record) {\n    if (record.isNew()) {\n        return Promise.reject({\n            code: \"NOT_DELETED\",\n            message: \"Record is new. Cannot be deleted\"\n        });\n    }\n    var conn = null;\n    return db.getConnection()\n        .then(function (newconn) {\n            conn = newconn\n            return conn.beginTransaction();\n        }).then(function () {\n            var del = orm.generate_delete_sql(record);\n            //console.log(del.sql)\n            //console.log(del.values)\n            return conn.query(del.sql, del.values)\n        }).then(function (info) {\n            //console.log(info)\n            if (info.affectedRows != 1) {\n                //console.log(info.affectedRows)\n                throw {code: \"NOT_DELETED\", message: \"Record might have been modified by other user.\"};\n            }\n            return delete_details_and_finish_function(conn, record);\n        }).finally(function (err) {\n            if (conn != null) {\n                conn.release()\n                conn = null;\n                //console.log(err, conn)\n            }\n        })\n}\n\norm.select = function select(recordClass) {\n    //return Query.select(recordClass)\n\n    var conn = null;\n    return db.getConnection()\n        .then(function (newconn) {\n            conn = newconn;\n            var select = orm.generate_select_sql(recordClass);\n            return conn.query(select.sql, select.values)\n        })\n        .spread(function (rows, fields) {\n            var result = []\n            for (var i=0;i<rows.length;i++) {\n                var record = recordClass.new();\n                ormutils.fill_record_with_query_result(record, rows[i], fields)\n                result.push(record);\n            }\n            return result;\n        })\n\n}\n\norm.generate_select_sql = function generate_select_sql(record) {\n    var fieldnames = record.fieldNames();\n    var questions = [];\n    var values = [];\n    var snames = []\n    var where = []\n\n    for (var i = 0; i < fieldnames.length; i++) {\n        var fn = fieldnames[i];\n        snames.push(\"`\" + fn + \"`\");\n        var value = record[fn];\n        if (value != null) {\n            //where.push(\"`\" + fn + \"` = ?\");\n            values.push(record[fn]);\n        }\n    }\n    var sql = \"SELECT \" + snames.join(\",\") + \" FROM \" + record.__description__.name; // + \" WHERE \" + where.join(\" AND \") + \" LIMIT 1\";\n    return {sql: sql, values: values};\n}\n\nmodule.exports = orm"]}