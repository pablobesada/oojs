{"version":3,"sources":["../../node_modules/openorange/lib/orm.es6"],"names":[],"mappings":"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","file":"orm.js","sourcesContent":["\"use strict\";\nvar db = require(\"./db\")\nvar async = require(\"async\")\nvar Promise = require(\"bluebird\")\nvar ormutils = require(\"./ormutils.js\")\nvar Query = require(\"./serverquery.js\")\nlet ctx = require(\"./contextmanager.js\")\n\nPromise.config({\n    longStackTraces: true\n})\nvar orm = {}\n\nfunction raw_insert_row_function(connection, record) {\n    var insert = orm.generate_insert_sql(record);\n    //console.log(insert.sql)\n    return connection.query(insert.sql, insert.values)\n        .then(function (info) {\n            record.internalId = info.insertId;\n            record.syncVersion = 1;\n            record.setNewFlag(false);\n            record.setModifiedFlag(false);\n        })\n}\n\nfunction raw_delete_row_function(connection, record) {\n    var del = orm.generate_delete_sql(record);\n    //console.log(del.sql)\n    //console.log(del.values)\n    return connection.query(del.sql, del.values)\n        .then(function (info) {\n            if (info.affectedRows != 1) {\n                throw {code: \"ROW_NOT_DELETED\", message: \"Row couldn't be deleted\"}\n                return;\n            }\n        })\n}\n\nfunction raw_update_row_function(connection, record) {\n    var update = orm.generate_update_sql(record);\n    //console.log(update.sql)\n    return connection.query(update.sql, update.values)\n        .then(function (info) {\n            if (info.changedRows != 1) {\n                throw {code: \"ROW_NOT_UPDATED\", message: \"Row couldn't be updated\"}\n            } else {\n                record.setNewFlag(false);\n                record.setModifiedFlag(false);\n            }\n        })\n}\n\nfunction deleteDetailFunction(connection, record, detailname) {\n    var detail = record.details(detailname);\n    var del = orm.generate_delete_detail_sql(record, detailname);\n    //console.log(del.sql)\n    //console.log(del.values)\n    return connection.query(del.sql, del.values)\n}\n\nfunction saveDetailFunction(connection, record, detailname) {\n    var funcs = [];\n    return new Promise(function (resolve, reject) {\n        var detail = record.details(detailname);\n        for (var i = 0; i < detail.length; i++) {\n            var row = detail[i];\n            row.masterId = record.internalId;\n            row.rowNr = i;\n            if (row.isModified()) {\n                if (row.isNew()) {\n                    funcs.push(raw_insert_row_function(connection, row))\n                } else {\n                    funcs.push(raw_update_row_function(connection, row))\n                }\n            }\n        }\n        for (var i = 0; i < detail.__removed_rows__.length; i++) {\n            var row = detail.__removed_rows__[i];\n            if (!row.isNew()) {\n                funcs.push(raw_delete_row_function(connection, row))\n            }\n        }\n        resolve();\n    }).then(function () {\n        return Promise.all(funcs)\n    })\n}\n\norm.generate_insert_sql = function generate_insert_sql(record) {\n    var fieldnames = record.persistentFieldNames();\n    var questions = [];\n    var values = [];\n    var fnames = []\n\n    for (var i = 0; i < fieldnames.length; i++) {\n        var fn = fieldnames[i];\n        if (fn == 'internalId') continue;\n        fnames.push(\"`\" + fn + \"`\");\n        questions.push(\"?\");\n        if (fn == 'syncVersion') {\n            values.push(1);\n        } else {\n            values.push(record.fields(fn).getSQLValue());\n        }\n    }\n    var sql = \"INSERT INTO \" + record.__class__.__description__.name + \" (\" + fnames.join(\",\") + \") VALUES (\" + questions.join(\",\") + \")\";\n    return {sql: sql, values: values};\n}\n\norm.generate_update_sql = function generate_update_sql(record) {\n    var fieldnames = record.persistentFieldNames();\n    var values = [];\n    var setfields = [];\n    var where = [];\n    for (var i = 0; i < fieldnames.length; i++) {\n        var fn = fieldnames[i];\n        setfields.push(\"`\" + fn + \"`=?\");\n        if (fn == 'syncVersion') {\n            values.push(record[fn] + 1);\n        } else {\n            values.push(record.fields(fn).getSQLValue());\n        }\n    }\n    where.push(\"`internalId`=?\");\n    values.push(record.oldFields(\"internalId\").getSQLValue());\n    if (record.hasField(\"syncVersion\")) {\n        where.push(\"`syncVersion`=?\");\n        values.push(record.oldFields(\"syncVersion\").getSQLValue());\n    }\n    var sql = \"UPDATE \" + record.__class__.__description__.name + \" SET \" + setfields.join(\",\") + \" WHERE \" + where.join(\" AND \");\n    return {sql: sql, values: values};\n}\n\norm.generate_delete_sql = function generate_update_sql(record) {\n    var values = [];\n    var where = [];\n    where.push(\"`internalId`=?\");\n    values.push(record.internalId);\n    if (record.hasField(\"syncVersion\")) {\n        where.push(\"`syncVersion`=?\");\n        values.push(record.syncVersion);\n    }\n    var sql = \"DELETE FROM \" + record.__description__.name + \" WHERE \" + where.join(\" AND \");\n    return {sql: sql, values: values};\n}\n\norm.generate_delete_detail_sql = function generate_update_sql(record, detailname) {\n    var values = [];\n    var where = [];\n    where.push(\"`masterId`=?\");\n    values.push(record.internalId);\n    var sql = \"DELETE FROM \" + record.details(detailname).__description__.class + \" WHERE \" + where.join(\" AND \");\n    return {sql: sql, values: values};\n}\n\nfunction select_detail_function2(conn, record, dn) {\n    return function (cb) {\n        var select = orm.generate_select_detail_sql(record, dn);\n        //console.log(select.sql)\n        var detail = record.details(dn);\n        conn.query(select.sql, select.values, function (err, rows, fields) {\n            if (err) {\n                cb(err);\n                return;\n            }\n            rows.forEach(function (row) {\n                var rw = detail.newRow();\n                ormutils.fill_record_with_query_result(rw, row, fields);\n                detail.push(rw);\n                rw.setNewFlag(false);\n                rw.setModifiedFlag(false);\n            })\n            cb(null);\n            return;\n        })\n    }\n}\n\nfunction select_detail_function(conn, record, dn) {\n    var select = orm.generate_select_detail_sql(record, dn);\n    //console.log(select.sql)\n    var detail = record.details(dn);\n    return conn.query(select.sql, select.values)\n        .spread(function (rows, fields) {\n            rows.forEach(function (row) {\n                var rw = detail.newRow();\n                ormutils.fill_record_with_query_result(rw, row, fields);\n                detail.push(rw);\n                rw.setNewFlag(false);\n                rw.setModifiedFlag(false);\n            })\n        })\n}\n\n\norm.load = async function load(record) {\n    try {\n        //var conn = await db.getConnection()\n        var conn = await ctx.getDBConnection()\n        var select = orm.generate_load_sql(record);\n        //console.log(select.sql)\n        var qres = await conn.query(select.sql, select.values);\n        var rows = qres[0], fields = qres[1];\n        if (rows == 0) {\n            return false;\n        }\n        ormutils.fill_record_with_query_result(record, rows[0], fields)\n        record.setNewFlag(false);\n        record.setModifiedFlag(false);\n\n        var funcs = [];\n        record.persistentDetailNames().forEach(function (dn) {\n            funcs.push(select_detail_function(conn, record, dn))\n        })\n        await Promise.all(funcs);\n        //conn.release();\n        //conn = null;\n        record.syncOldFields();\n        return true;\n    } finally {\n        //if (conn != null) {\n        //    conn.release()\n        //    conn = null;\n        //console.log(err, conn)\n        //}\n    }\n}\n\norm.generate_load_sql = function generate_load_sql(record) {\n    var fieldnames = record.persistentFieldNames();\n    var questions = [];\n    var values = [];\n    var snames = []\n    var where = []\n\n    for (let i = 0; i < fieldnames.length; i++) {\n        let fn = fieldnames[i];\n        snames.push(\"`\" + fn + \"`\");\n        let value = record.fields(fn).getSQLValue();\n        if (value != null) {\n            where.push(\"`\" + fn + \"` = ?\");\n            values.push(value);\n        }\n    }\n    var sql = \"SELECT \" + snames.join(\",\") + \" FROM \" + record.__class__.__description__.name + \" WHERE \" + where.join(\" AND \") + \" LIMIT 1\";\n    if (where.length == 0) {\n        console.log(sql)\n        throw new Error(\"Imposible hacer select sin valores\")\n    }\n    return {sql: sql, values: values};\n}\n\norm.generate_select_detail_sql = function generate_select_detail_sql(record, detailname) {\n    var detail = record.details(detailname);\n    var fieldnames = detail.fieldNames();\n    var questions = [];\n    var values = [record.internalId];\n    var snames = []\n    var where = \"`masterId`=?\";\n    var order = \"rowNr ASC\";\n\n    for (var i = 0; i < fieldnames.length; i++) {\n        var fn = fieldnames[i];\n        snames.push(\"`\" + fn + \"`\");\n    }\n    var sql = \"SELECT \" + snames.join(\",\") + \" FROM \" + detail.__description__.class + \" WHERE \" + where + \" ORDER BY \" + order;\n    return {sql: sql, values: values};\n}\n\nasync function save_details_and_finish_function(conn, record) {\n    try {\n        var funcs = [];\n        await new Promise(function (resolve, reject) {\n            for (var i = 0; i < record.persistentDetailNames().length; i++) {\n                var f = saveDetailFunction(conn, record, record.persistentDetailNames()[i]);\n                funcs.push(f);\n            }\n            resolve()\n        });\n        await Promise.all(funcs);\n        //await conn.commit();\n        return true;\n    } catch (err) {\n        //await conn.rollback(conn);\n        return false;\n    }\n}\n\n\nasync function save_new(conn, record) {\n    //await conn.beginTransaction()\n    var insert = orm.generate_insert_sql(record);\n    var info = await conn.query(insert.sql, insert.values)\n    record.internalId = info.insertId;\n    record.syncVersion = 1;\n    record.setNewFlag(false);\n    record.setModifiedFlag(false);\n    return save_details_and_finish_function(conn, record)\n}\n\nasync function save_existing(conn, record) {\n    //await conn.beginTransaction();\n    let update = orm.generate_update_sql(record);\n    let info = await conn.query(update.sql, update.values)\n    if (info.changedRows != 1) {\n        console.log({code: \"WRONG_SYNCVERSION\", message: \"Record might have been modified by other user \"})\n        return false\n    }\n    record.syncVersion += 1;\n    record.setNewFlag(false);\n    record.setModifiedFlag(false);\n    return save_details_and_finish_function(conn, record);\n}\n\nfunction delete_details_and_finish_function(conn, record) {\n    var funcs = [];\n    return new Promise(function (resolve, reject) {\n        for (var i = 0; i < record.detailNames().length; i++) {\n            var f = deleteDetailFunction(conn, record, record.detailNames()[i]);\n            funcs.push(f);\n        }\n        resolve();\n    })\n        .then(function () {\n            return Promise.all(funcs)\n        })\n        .then(\n            function () {\n                record.syncOldFields()\n                //return conn.commit().then(function () {\n                //\n                //})\n            },\n            function onReject(err) {\n                Promise.reject(err);\n            }\n        )\n}\n\norm.store = async function store(record, callback) {\n    let res = true;\n    if (!record.isNew() && !record.isModified()) {\n        return true;\n    }\n    try {\n        //var conn = await .getConnection();\n        var conn = await ctx.getDBConnection();\n        if (record.isNew()) {\n            let res = await save_new(conn, record);\n            if (!res) return res;\n        } else if (record.isModified()) {\n            let res = await save_existing(conn, record);\n            if (!res) return res;\n        }\n        //record.syncOldFields(); ya no se hace aca\n    } catch (err) {\n        await conn.rollback()\n        throw err\n    }\n    return true;\n}\n\norm.delete = function (record) {\n    if (record.isNew()) {\n        return Promise.reject({\n            code: \"NOT_DELETED\",\n            message: \"Record is new. Cannot be deleted\"\n        });\n    }\n    var conn = null;\n    //return db.getConnection()\n    return ctx.getDBConnection()\n    then(function (newconn) {\n        conn = newconn\n        //return conn.beginTransaction();\n        //}).then(function () {\n        var del = orm.generate_delete_sql(record);\n        //console.log(del.sql)\n        //console.log(del.values)\n        return conn.query(del.sql, del.values)\n    }).then(function (info) {\n        //console.log(info)\n        if (info.affectedRows != 1) {\n            //console.log(info.affectedRows)\n            throw {code: \"NOT_DELETED\", message: \"Record might have been modified by other user.\"};\n        }\n        return delete_details_and_finish_function(conn, record);\n    }).finally(function (err) {\n        //if (conn != null) {\n        //    conn.release()\n        //    conn = null;\n        //    //console.log(err, conn)\n        // }\n    })\n}\n\norm.select = function select(recordClass) {\n    //return Query.select(recordClass)\n\n    var conn = null;\n    //return db.getConnection()\n    return ctx.getDBConnection()\n        .then(function (newconn) {\n            conn = newconn;\n            var select = orm.generate_select_sql(recordClass);\n            return conn.query(select.sql, select.values)\n        })\n        .spread(function (rows, fields) {\n            var result = []\n            for (var i = 0; i < rows.length; i++) {\n                var record = recordClass.new();\n                ormutils.fill_record_with_query_result(record, rows[i], fields)\n                result.push(record);\n            }\n            return result;\n        })\n\n}\n\norm.generate_select_sql = function generate_select_sql(record) {\n    var fieldnames = record.fieldNames();\n    var questions = [];\n    var values = [];\n    var snames = []\n    var where = []\n\n    for (var i = 0; i < fieldnames.length; i++) {\n        var fn = fieldnames[i];\n        snames.push(\"`\" + fn + \"`\");\n        var value = record[fn];\n        if (value != null) {\n            //where.push(\"`\" + fn + \"` = ?\");\n            values.push(record[fn]);\n        }\n    }\n    var sql = \"SELECT \" + snames.join(\",\") + \" FROM \" + record.__description__.name; // + \" WHERE \" + where.join(\" AND \") + \" LIMIT 1\";\n    return {sql: sql, values: values};\n}\n\nmodule.exports = orm"]}