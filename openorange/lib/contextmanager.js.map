{"version":3,"sources":["../../node_modules/openorange/lib/contextmanager.es6"],"names":[],"mappings":";;;;;;;;AAAA,IAAI,2BAA2B,QAAQ,4BAAR,CAA/B;AACA,IAAI,UAAU,yBAAyB,eAAzB,CAAyC,kCAAzC,CAAd;;IAEM,c;;;;;;;4CAEyB;;AAEvB,mBAAO,UAAS,GAAT,EAAc,GAAd,EAAmB,IAAnB,EAAyB;AAC5B,wBAAQ,WAAR,CAAoB,GAApB;AACA,wBAAQ,WAAR,CAAoB,GAApB;;AAEA,wBAAQ,GAAR,CAAY,YAAW;;;AAGnB,4BAAQ,GAAR,CAAY,iBAAZ,EAA+B,IAAI,OAAnC;AACA;AACH,iBALD;AAOH,aAXD;AAYH;;;qCAEmB;AAChB,mBAAO,OAAP;AACH;;;uCACqB,O,EAAS;AAC3B,qCAAyB,YAAzB,CAAsC,kCAAtC,EAA0E,GAA1E,CAA8E,iBAA9E,EAAiG,OAAjG;;AAEH;;;4CAE0B;AACvB,mBAAO,QAAQ,GAAR,CAAY,iBAAZ,KAAkC,EAAC,IAAI,eAAL,EAAzC;AACH;;;;;oBAGO,O,EAEA,G,EAGA,W,EACK,C,EACD,K,EAKJ,I;;;;;;AAZA,uC,GAAU,KAAK,iBAAL,E;;;AAEV,mC,GAAM,QAAQ,E;;;AAElB,oCAAI,CAAC,KAAK,aAAL,CAAmB,GAAnB,CAAL,EAA8B,KAAK,aAAL,CAAmB,GAAnB,IAA0B,EAA1B;AAC1B,2C,GAAc,KAAK,aAAL,CAAmB,GAAnB,C;sEACJ,W;;;;;;;;AAAL,iC;AACD,qC,GAAO,YAAY,CAAZ,C;;oCACN,MAAK,I;;;;;iEACC,K;;;;;;;;uCAGE,QAAQ,MAAR,EAAgB,aAAhB,E;;;AAAb,oC;;AACJ,qCAAK,aAAL,CAAmB,GAAnB,EAAwB,IAAxB,CAA6B,IAA7B;iEACO,I;;;;;;;;;;;;;;;;;;;;oBAIH,I;;;;;;uCAAa,KAAK,eAAL,E;;;AAAb,oC;kEACG,KAAK,gBAAL,E;;;;;;;;;;;;;;;;;;;;oBAIH,I;;;;;;uCAAa,KAAK,eAAL,E;;;AAAb,oC;kEACG,KAAK,MAAL,E;;;;;;;;;;;;;;;;;;;;oBAIH,I;;;;;;uCAAa,KAAK,eAAL,E;;;AAAb,oC;kEACG,KAAK,QAAL,E;;;;;;;;;;;;;;;;;;sCAGU;AACjB,gBAAI,UAAU,KAAK,iBAAL,EAAd;AACA,mBAAO,QAAQ,IAAf;AACH;;;;;;AAIL,eAAe,aAAf,GAA+B,EAA/B,C;;AAEA,OAAO,OAAP,GAAiB,cAAjB","file":"contextmanager.js","sourcesContent":["let continuationLocalStorage = require('continuation-local-storage')\nlet context = continuationLocalStorage.createNamespace('openorange-async-session-context');\n\nclass ContextManager {\n\n    static expressMiddleware() {\n\n        return function(req, res, next) {\n            context.bindEmitter(req);\n            context.bindEmitter(res);\n            //console.log(\"en middleware\")\n            context.run(function() {\n                //console.log(\"en middleware 2\", req.session)\n                //console.log(\"req.sessionID: \", req.sessionID, \"   session.id: \" + req.session.id)\n                context.set('request-session', req.session);\n                next();\n            });\n\n        };\n    }\n\n    static getContext() {\n        return context;\n    }\n    static recoverContext(session) {\n        continuationLocalStorage.getNamespace('openorange-async-session-context').set('request-session', session);\n        //context.set('request-session', session);\n    }\n\n    static getRequestSession() {\n        return context.get('request-session') || {id: 'local-session'};\n    }\n\n    static async getDBConnection() {\n        let session = this.getRequestSession();\n        //console.log(\"SID: \" + session.id)\n        let sid = session.id\n        //sid = '123'\n        if (!this.dbconnections[sid]) this.dbconnections[sid] = []\n        let connections = this.dbconnections[sid];\n        for (let i in connections) {\n            let conn = connections[i];\n            if (!conn.busy) {\n                return conn;\n            }\n        }\n        let conn = await require(\"./db\").getConnection();\n        this.dbconnections[sid].push(conn)\n        return conn;\n    }\n\n    static async beginTransaction() {\n        let conn = await this.getDBConnection();\n        return conn.beginTransaction();\n    }\n\n    static async commit() {\n        let conn = await this.getDBConnection();\n        return conn.commit();\n    }\n\n    static async rollback() {\n        let conn = await this.getDBConnection();\n        return conn.rollback();\n    }\n\n    static currentUser() {\n        let session = this.getRequestSession()\n        return session.user;\n    }\n\n\n}\nContextManager.dbconnections = {} ///cuando se liberan borran las connectiosn de este map???\n\nmodule.exports = ContextManager"]}