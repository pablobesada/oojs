{"version":3,"sources":["Auth.js"],"names":[],"mappings":"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","file":"Auth-compiled.js","sourcesContent":["var Buffer = require('buffer').Buffer;\nvar Crypto = require('crypto');\nvar Auth   = exports;\n\nfunction sha1(msg) {\n  var hash = Crypto.createHash('sha1');\n  hash.update(msg, 'binary');\n  return hash.digest('binary');\n}\nAuth.sha1 = sha1;\n\nfunction xor(a, b) {\n  a = new Buffer(a, 'binary');\n  b = new Buffer(b, 'binary');\n  var result = new Buffer(a.length);\n  for (var i = 0; i < a.length; i++) {\n    result[i] = (a[i] ^ b[i]);\n  }\n  return result;\n}\nAuth.xor = xor;\n\nAuth.token = function(password, scramble) {\n  if (!password) {\n    return new Buffer(0);\n  }\n\n  // password must be in binary format, not utf8\n  var stage1 = sha1((new Buffer(password, \"utf8\")).toString(\"binary\"));\n  var stage2 = sha1(stage1);\n  var stage3 = sha1(scramble.toString('binary') + stage2);\n  return xor(stage3, stage1);\n};\n\n// This is a port of sql/password.c:hash_password which needs to be used for\n// pre-4.1 passwords.\nAuth.hashPassword = function(password) {\n  var nr = [0x5030, 0x5735],\n      add = 7,\n      nr2 = [0x1234, 0x5671],\n      result = new Buffer(8);\n\n  if (typeof password == 'string'){\n    password = new Buffer(password);\n  }\n\n  for (var i = 0; i < password.length; i++) {\n    var c = password[i];\n    if (c == 32 || c == 9) {\n      // skip space in password\n      continue;\n    }\n\n    // nr^= (((nr & 63)+add)*c)+ (nr << 8);\n    // nr = xor(nr, add(mul(add(and(nr, 63), add), c), shl(nr, 8)))\n    nr = this.xor32(nr, this.add32(this.mul32(this.add32(this.and32(nr, [0,63]), [0,add]), [0,c]), this.shl32(nr, 8)));\n\n    // nr2+=(nr2 << 8) ^ nr;\n    // nr2 = add(nr2, xor(shl(nr2, 8), nr))\n    nr2 = this.add32(nr2, this.xor32(this.shl32(nr2, 8), nr));\n\n    // add+=tmp;\n    add += c;\n  }\n\n  this.int31Write(result, nr, 0);\n  this.int31Write(result, nr2, 4);\n\n  return result;\n};\n\nAuth.randomInit = function(seed1, seed2) {\n  return {\n    max_value: 0x3FFFFFFF,\n    max_value_dbl: 0x3FFFFFFF,\n    seed1: seed1 % 0x3FFFFFFF,\n    seed2: seed2 % 0x3FFFFFFF\n  };\n};\n\nAuth.myRnd = function(r){\n  r.seed1 = (r.seed1 * 3 + r.seed2) % r.max_value;\n  r.seed2 = (r.seed1 + r.seed2 + 33) % r.max_value;\n\n  return r.seed1 / r.max_value_dbl;\n};\n\nAuth.scramble323 = function(message, password) {\n  var to = new Buffer(8),\n      hashPass = this.hashPassword(password),\n      hashMessage = this.hashPassword(message.slice(0, 8)),\n      seed1 = this.int32Read(hashPass, 0) ^ this.int32Read(hashMessage, 0),\n      seed2 = this.int32Read(hashPass, 4) ^ this.int32Read(hashMessage, 4),\n      r = this.randomInit(seed1, seed2);\n\n  for (var i = 0; i < 8; i++){\n    to[i] = Math.floor(this.myRnd(r) * 31) + 64;\n  }\n  var extra = (Math.floor(this.myRnd(r) * 31));\n\n  for (var i = 0; i < 8; i++){\n    to[i] ^= extra;\n  }\n\n  return to;\n};\n\nAuth.fmt32 = function(x){\n  var a = x[0].toString(16),\n      b = x[1].toString(16);\n\n  if (a.length == 1) a = '000'+a;\n  if (a.length == 2) a = '00'+a;\n  if (a.length == 3) a = '0'+a;\n  if (b.length == 1) b = '000'+b;\n  if (b.length == 2) b = '00'+b;\n  if (b.length == 3) b = '0'+b;\n  return '' + a + '/' + b;\n};\n\nAuth.xor32 = function(a,b){\n  return [a[0] ^ b[0], a[1] ^ b[1]];\n};\n\nAuth.add32 = function(a,b){\n  var w1 = a[1] + b[1],\n      w2 = a[0] + b[0] + ((w1 & 0xFFFF0000) >> 16);\n\n  return [w2 & 0xFFFF, w1 & 0xFFFF];\n};\n\nAuth.mul32 = function(a,b){\n  // based on this example of multiplying 32b ints using 16b\n  // http://www.dsprelated.com/showmessage/89790/1.php\n  var w1 = a[1] * b[1],\n      w2 = (((a[1] * b[1]) >> 16) & 0xFFFF) + ((a[0] * b[1]) & 0xFFFF) + (a[1] * b[0] & 0xFFFF);\n\n  return [w2 & 0xFFFF, w1 & 0xFFFF];\n};\n\nAuth.and32 = function(a,b){\n  return [a[0] & b[0], a[1] & b[1]];\n};\n\nAuth.shl32 = function(a,b){\n  // assume b is 16 or less\n  var w1 = a[1] << b,\n      w2 = (a[0] << b) | ((w1 & 0xFFFF0000) >> 16);\n\n  return [w2 & 0xFFFF, w1 & 0xFFFF];\n};\n\nAuth.int31Write = function(buffer, number, offset) {\n  buffer[offset] = (number[0] >> 8) & 0x7F;\n  buffer[offset + 1] = (number[0]) & 0xFF;\n  buffer[offset + 2] = (number[1] >> 8) & 0xFF;\n  buffer[offset + 3] = (number[1]) & 0xFF;\n};\n\nAuth.int32Read = function(buffer, offset){\n  return (buffer[offset] << 24)\n       + (buffer[offset+1] << 16)\n       + (buffer[offset+2] << 8)\n       + (buffer[offset+3]);\n};\n"]}