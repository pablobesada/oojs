{"version":3,"sources":["Query.js"],"names":[],"mappings":"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","file":"Query-compiled.js","sourcesContent":["var Sequence     = require('./Sequence');\nvar Util         = require('util');\nvar Packets      = require('../packets');\nvar ResultSet    = require('../ResultSet');\nvar ServerStatus = require('../constants/server_status');\nvar fs           = require('fs');\nvar Readable     = require('readable-stream');\n\nmodule.exports = Query;\nUtil.inherits(Query, Sequence);\nfunction Query(options, callback) {\n  Sequence.call(this, options, callback);\n\n  this.sql = options.sql;\n  this.values = options.values;\n  this.typeCast = (options.typeCast === undefined)\n    ? true\n    : options.typeCast;\n  this.nestTables = options.nestTables || false;\n\n  this._resultSet = null;\n  this._results   = [];\n  this._fields    = [];\n  this._index     = 0;\n  this._loadError = null;\n}\n\nQuery.prototype.start = function() {\n  this.emit('packet', new Packets.ComQueryPacket(this.sql));\n};\n\nQuery.prototype.determinePacket = function(firstByte, parser) {\n  if (firstByte === 0) {\n    // If we have a resultSet and got one eofPacket\n    if (this._resultSet && this._resultSet.eofPackets.length === 1) {\n      // Then this is a RowDataPacket with an empty string in the first column.\n      // See: https://github.com/felixge/node-mysql/issues/222\n    } else if (this._resultSet && this._resultSet.resultSetHeaderPacket\n           && this._resultSet.resultSetHeaderPacket.fieldCount !== null) {\n      return Packets.FieldPacket;\n    } else {\n      return;\n    }\n  }\n\n  if (firstByte === 255) {\n    return;\n  }\n\n  // EofPacket's are 5 bytes in mysql >= 4.1\n  // This is the only / best way to differentiate their firstByte from a 9\n  // byte length coded binary.\n  if (firstByte === 0xfe && parser.packetLength() < 9) {\n    return Packets.EofPacket;\n  }\n\n  if (!this._resultSet) {\n    return Packets.ResultSetHeaderPacket;\n  }\n\n  return (this._resultSet.eofPackets.length === 0)\n    ? Packets.FieldPacket\n    : Packets.RowDataPacket;\n};\n\nQuery.prototype['OkPacket'] = function(packet) {\n  // try...finally for exception safety\n  try {\n    if (!this._callback) {\n      this.emit('result', packet, this._index);\n    } else {\n      this._results.push(packet);\n      this._fields.push(undefined);\n    }\n  } finally {\n    this._index++;\n    this._resultSet = null;\n    this._handleFinalResultPacket(packet);\n  }\n};\n\nQuery.prototype['ErrorPacket'] = function(packet) {\n  var err = this._packetToError(packet);\n\n  var results = (this._results.length > 0)\n    ? this._results\n    : undefined;\n\n  var fields = (this._fields.length > 0)\n    ? this._fields\n    : undefined;\n\n  err.index = this._index;\n  this.end(err, results, fields);\n};\n\nQuery.prototype['ResultSetHeaderPacket'] = function(packet) {\n  this._resultSet = new ResultSet(packet);\n\n  // used by LOAD DATA LOCAL INFILE queries\n  if (packet.fieldCount === null) {\n    this._sendLocalDataFile(packet.extra);\n  }\n};\n\nQuery.prototype['FieldPacket'] = function(packet) {\n  this._resultSet.fieldPackets.push(packet);\n};\n\nQuery.prototype['EofPacket'] = function(packet) {\n  this._resultSet.eofPackets.push(packet);\n\n  if (this._resultSet.eofPackets.length === 1 && !this._callback) {\n    this.emit('fields', this._resultSet.fieldPackets, this._index);\n  }\n\n  if (this._resultSet.eofPackets.length !== 2) {\n    return;\n  }\n\n  if (this._callback) {\n    this._results.push(this._resultSet.rows);\n    this._fields.push(this._resultSet.fieldPackets);\n  }\n\n  this._index++;\n  this._resultSet = null;\n  this._handleFinalResultPacket(packet);\n};\n\nQuery.prototype._handleFinalResultPacket = function(packet) {\n  if (packet.serverStatus & ServerStatus.SERVER_MORE_RESULTS_EXISTS) {\n    return;\n  }\n\n  var results = (this._results.length > 1)\n    ? this._results\n    : this._results[0];\n\n  var fields = (this._fields.length > 1)\n    ? this._fields\n    : this._fields[0];\n\n  this.end(this._loadError, results, fields);\n};\n\nQuery.prototype['RowDataPacket'] = function(packet, parser, connection) {\n  packet.parse(parser, this._resultSet.fieldPackets, this.typeCast, this.nestTables, connection);\n\n  if (this._callback) {\n    this._resultSet.rows.push(packet);\n  } else {\n    this.emit('result', packet, this._index);\n  }\n};\n\nQuery.prototype._sendLocalDataFile = function(path) {\n  var self = this;\n  var localStream = fs.createReadStream(path, {\n    'flag': 'r',\n    'encoding': null,\n    'autoClose': true\n  });\n\n\n  this.on('pause', function () {\n    localStream.pause();\n  });\n\n  this.on('resume', function () {\n    localStream.resume();\n  });\n\n  localStream.on('data', function (data) {\n    self.emit('packet', new Packets.LocalDataFilePacket(data));\n  });\n\n  localStream.on('error', function (err) {\n    self._loadError = err;\n    localStream.emit('end');\n  });\n\n  localStream.on('end', function () {\n    self.emit('packet', new Packets.EmptyPacket());\n  });\n};\n\nQuery.prototype.stream = function(options) {\n  var self = this,\n      stream;\n\n  options = options || {};\n  options.objectMode = true;\n  stream = new Readable(options);\n\n  stream._read = function() {\n    self._connection && self._connection.resume();\n  };\n\n  this.on('result',function(row,i) {\n    if (!stream.push(row)) self._connection.pause();\n    stream.emit('result',row,i);  // replicate old emitter\n  });\n\n  this.on('error',function(err) {\n    stream.emit('error',err);  // Pass on any errors\n  });\n\n  this.on('end', function() {\n    stream.emit('close');  // notify readers that query has completed\n    stream.push(null);  // pushing null, indicating EOF\n  });\n\n  this.on('fields',function(fields,i) {\n    stream.emit('fields',fields,i);  // replicate old emitter\n  });\n\n  return stream;\n};\n"]}