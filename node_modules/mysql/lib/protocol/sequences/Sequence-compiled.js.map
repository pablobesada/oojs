{"version":3,"sources":["Sequence.js"],"names":[],"mappings":"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","file":"Sequence-compiled.js","sourcesContent":["var Util           = require('util');\nvar EventEmitter   = require('events').EventEmitter;\nvar Packets        = require('../packets');\nvar ErrorConstants = require('../constants/errors');\n\nvar listenerCount = EventEmitter.listenerCount\n  || function(emitter, type){ return emitter.listeners(type).length; };\n\nmodule.exports = Sequence;\nUtil.inherits(Sequence, EventEmitter);\nfunction Sequence(options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  EventEmitter.call(this);\n\n  options = options || {};\n\n  this._callback = callback;\n  this._callSite = null;\n  this._ended    = false;\n  this._timeout  = options.timeout;\n\n  // For Timers\n  this._idleNext    = null;\n  this._idlePrev    = null;\n  this._idleStart   = null;\n  this._idleTimeout = undefined;\n  this._repeat      = null;\n}\n\nSequence.determinePacket = function(byte) {\n  switch (byte) {\n    case 0x00: return Packets.OkPacket;\n    case 0xfe: return Packets.EofPacket;\n    case 0xff: return Packets.ErrorPacket;\n  }\n};\n\nSequence.prototype.hasErrorHandler = function() {\n  return Boolean(this._callback) || listenerCount(this, 'error') > 1;\n};\n\nSequence.prototype._packetToError = function(packet) {\n  var code = ErrorConstants[packet.errno] || 'UNKNOWN_CODE_PLEASE_REPORT';\n  var err  = new Error(code + ': ' + packet.message);\n  err.code = code;\n  err.errno = packet.errno;\n  err.sqlState = packet.sqlState;\n\n  return err;\n};\n\nSequence.prototype._addLongStackTrace = function _addLongStackTrace(err) {\n  if (!this._callSite || !this._callSite.stack) {\n    return;\n  }\n\n  var delimiter = '\\n    --------------------\\n';\n\n  if (err.stack.indexOf(delimiter) > -1) {\n    return;\n  }\n\n  err.stack += delimiter + this._callSite.stack.replace(/.+\\n/, '');\n};\n\nSequence.prototype.end = function(err) {\n  if (this._ended) {\n    return;\n  }\n\n  this._ended = true;\n\n  if (err) {\n    this._addLongStackTrace(err);\n  }\n\n  // Without this we are leaking memory. This problem was introduced in\n  // 8189925374e7ce3819bbe88b64c7b15abac96b16. I suspect that the error object\n  // causes a cyclic reference that the GC does not detect properly, but I was\n  // unable to produce a standalone version of this leak. This would be a great\n  // challenge for somebody interested in difficult problems : )!\n  this._callSite = null;\n\n  // try...finally for exception safety\n  try {\n    if (err) {\n      this.emit('error', err);\n    }\n  } finally {\n    try {\n      if (this._callback) {\n        this._callback.apply(this, arguments);\n      }\n    } finally {\n      this.emit('end');\n    }\n  }\n};\n\nSequence.prototype['OkPacket'] = function(packet) {\n  this.end(null, packet);\n};\n\nSequence.prototype['ErrorPacket'] = function(packet) {\n  this.end(this._packetToError(packet));\n};\n\n// Implemented by child classes\nSequence.prototype.start = function() {};\n\nSequence.prototype._onTimeout = function _onTimeout() {\n  this.emit('timeout');\n};\n"]}