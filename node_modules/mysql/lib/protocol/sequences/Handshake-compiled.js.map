{"version":3,"sources":["Handshake.js"],"names":[],"mappings":"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","file":"Handshake-compiled.js","sourcesContent":["var Sequence        = require('./Sequence');\nvar Util            = require('util');\nvar Packets         = require('../packets');\nvar Auth            = require('../Auth');\nvar ClientConstants = require('../constants/client');\n\nmodule.exports = Handshake;\nUtil.inherits(Handshake, Sequence);\nfunction Handshake(options, callback) {\n  Sequence.call(this, options, callback);\n\n  options = options || {};\n\n  this._config                        = options.config;\n  this._handshakeInitializationPacket = null;\n}\n\nHandshake.prototype.determinePacket = function(firstByte) {\n  if (firstByte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n\n  if (!this._handshakeInitializationPacket) {\n    return Packets.HandshakeInitializationPacket;\n  }\n\n  if (firstByte === 0xfe) {\n    return Packets.UseOldPasswordPacket;\n  }\n};\n\nHandshake.prototype['HandshakeInitializationPacket'] = function(packet) {\n  this._handshakeInitializationPacket = packet;\n\n  this._config.protocol41 = packet.protocol41;\n\n  var serverSSLSupport = packet.serverCapabilities1 & ClientConstants.CLIENT_SSL;\n\n  if (this._config.ssl) {\n    if (!serverSSLSupport) {\n      var err = new Error('Server does not support secure connnection');\n\n      err.code = 'HANDSHAKE_NO_SSL_SUPPORT';\n      err.fatal = true;\n\n      this.end(err);\n      return;\n    }\n\n    this._config.clientFlags |= ClientConstants.CLIENT_SSL;\n    this.emit('packet', new Packets.SSLRequestPacket({\n      clientFlags   : this._config.clientFlags,\n      maxPacketSize : this._config.maxPacketSize,\n      charsetNumber : this._config.charsetNumber\n    }));\n    this.emit('start-tls');\n  } else {\n    this._sendCredentials();\n  }\n};\n\nHandshake.prototype._tlsUpgradeCompleteHandler = function() {\n  this._sendCredentials();\n};\n\nHandshake.prototype._sendCredentials = function(serverHello) {\n  var packet = this._handshakeInitializationPacket;\n  this.emit('packet', new Packets.ClientAuthenticationPacket({\n    clientFlags   : this._config.clientFlags,\n    maxPacketSize : this._config.maxPacketSize,\n    charsetNumber : this._config.charsetNumber,\n    user          : this._config.user,\n    scrambleBuff  : (packet.protocol41)\n                     ? Auth.token(this._config.password, packet.scrambleBuff())\n                     : Auth.scramble323(packet.scrambleBuff(), this._config.password),\n    database      : this._config.database,\n    protocol41    : packet.protocol41\n  }));\n};\n\nHandshake.prototype['UseOldPasswordPacket'] = function(packet) {\n  if (!this._config.insecureAuth) {\n    var err = new Error(\n      'MySQL server is requesting the old and insecure pre-4.1 auth mechanism.' +\n      'Upgrade the user password or use the {insecureAuth: true} option.'\n    );\n\n    err.code = 'HANDSHAKE_INSECURE_AUTH';\n    err.fatal = true;\n\n    this.end(err);\n    return;\n  }\n\n  this.emit('packet', new Packets.OldPasswordPacket({\n    scrambleBuff : Auth.scramble323(this._handshakeInitializationPacket.scrambleBuff(), this._config.password)\n  }));\n};\n\nHandshake.prototype['ErrorPacket'] = function(packet) {\n  var err = this._packetToError(packet, true);\n  err.fatal = true;\n  this.end(err);\n};\n"]}