{"version":3,"sources":["Protocol.js"],"names":[],"mappings":"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","file":"Protocol-compiled.js","sourcesContent":["var Parser       = require('./Parser');\nvar Sequences    = require('./sequences');\nvar Packets      = require('./packets');\nvar Timers       = require('timers');\nvar Stream       = require('stream').Stream;\nvar Util         = require('util');\nvar PacketWriter = require('./PacketWriter');\n\nmodule.exports = Protocol;\nUtil.inherits(Protocol, Stream);\nfunction Protocol(options) {\n  Stream.call(this);\n\n  options = options || {};\n\n  this.readable = true;\n  this.writable = true;\n\n  this._config                        = options.config || {};\n  this._connection                    = options.connection;\n  this._callback                      = null;\n  this._fatalError                    = null;\n  this._quitSequence                  = null;\n  this._handshakeSequence             = null;\n  this._handshaked                    = false;\n  this._ended                         = false;\n  this._destroyed                     = false;\n  this._queue                         = [];\n  this._handshakeInitializationPacket = null;\n\n  this._parser = new Parser({\n    onError  : this.handleParserError.bind(this),\n    onPacket : this._parsePacket.bind(this),\n    config   : this._config\n  });\n}\n\nProtocol.prototype.write = function(buffer) {\n  this._parser.write(buffer);\n  return true;\n};\n\nProtocol.prototype.handshake = function handshake(options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  options = options || {};\n  options.config = this._config;\n\n  return this._handshakeSequence = this._enqueue(new Sequences.Handshake(options, callback));\n};\n\nProtocol.prototype.query = function query(options, callback) {\n  return this._enqueue(new Sequences.Query(options, callback));\n};\n\nProtocol.prototype.changeUser = function changeUser(options, callback) {\n  return this._enqueue(new Sequences.ChangeUser(options, callback));\n};\n\nProtocol.prototype.ping = function ping(options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  return this._enqueue(new Sequences.Ping(options, callback));\n};\n\nProtocol.prototype.stats = function stats(options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  return this._enqueue(new Sequences.Statistics(options, callback));\n};\n\nProtocol.prototype.quit = function quit(options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  var self     = this;\n  var sequence = this._enqueue(new Sequences.Quit(options, callback));\n\n  sequence.on('end', function () {\n    self.end();\n  });\n\n  return this._quitSequence = sequence;\n};\n\nProtocol.prototype.end = function() {\n  if(this._ended) {\n    return;\n  }\n  this._ended = true;\n\n  if (this._quitSequence && (this._quitSequence._ended || this._queue[0] === this._quitSequence)) {\n    this._quitSequence.end();\n    this.emit('end');\n    return;\n  }\n\n  var err = new Error('Connection lost: The server closed the connection.');\n  err.fatal = true;\n  err.code = 'PROTOCOL_CONNECTION_LOST';\n\n  this._delegateError(err);\n};\n\nProtocol.prototype.pause = function() {\n  this._parser.pause();\n  // Since there is a file stream in query, we must transmit pause/resume event to current sequence.\n  var seq = this._queue[0];\n  if (seq && seq.emit) {\n    seq.emit('pause');\n  }\n};\n\nProtocol.prototype.resume = function() {\n  this._parser.resume();\n  // Since there is a file stream in query, we must transmit pause/resume event to current sequence.\n  var seq = this._queue[0];\n  if (seq && seq.emit) {\n    seq.emit('resume');\n  }\n};\n\nProtocol.prototype._enqueue = function(sequence) {\n  if (!this._validateEnqueue(sequence)) {\n    return sequence;\n  }\n\n  if (this._config.trace) {\n    // Long stack trace support\n    sequence._callSite = sequence._callSite || new Error;\n  }\n\n  this._queue.push(sequence);\n  this.emit('enqueue', sequence);\n\n  var self = this;\n  sequence\n    .on('error', function(err) {\n      self._delegateError(err, sequence);\n    })\n    .on('packet', function(packet) {\n      Timers.active(sequence);\n      self._emitPacket(packet);\n    })\n    .on('end', function() {\n      self._dequeue(sequence);\n    })\n    .on('timeout', function() {\n      var err = new Error(sequence.constructor.name + ' inactivity timeout');\n\n      err.code    = 'PROTOCOL_SEQUENCE_TIMEOUT';\n      err.fatal   = true;\n      err.timeout = sequence._timeout;\n\n      self._delegateError(err, sequence);\n    })\n    .on('start-tls', function() {\n      Timers.active(sequence);\n      self._connection._startTLS(function(err) {\n        if (err) {\n          // SSL negotiation error are fatal\n          err.code  = 'HANDSHAKE_SSL_ERROR';\n          err.fatal = true;\n          sequence.end(err);\n          return;\n        }\n\n        Timers.active(sequence);\n        sequence._tlsUpgradeCompleteHandler();\n      });\n    });\n\n  if (this._queue.length === 1) {\n    this._parser.resetPacketNumber();\n    this._startSequence(sequence);\n  }\n\n  return sequence;\n};\n\nProtocol.prototype._validateEnqueue = function _validateEnqueue(sequence) {\n  var err;\n  var prefix = 'Cannot enqueue ' + sequence.constructor.name;\n  var prefixBefore = prefix + ' before ';\n  var prefixAfter = prefix + ' after ';\n\n  if (this._fatalError) {\n    err      = new Error(prefixAfter + 'fatal error.');\n    err.code = 'PROTOCOL_ENQUEUE_AFTER_FATAL_ERROR';\n  } else if (this._quitSequence) {\n    err      = new Error(prefixAfter + 'invoking quit.');\n    err.code = 'PROTOCOL_ENQUEUE_AFTER_QUIT';\n  } else if (this._destroyed) {\n    err      = new Error(prefixAfter + 'being destroyed.');\n    err.code = 'PROTOCOL_ENQUEUE_AFTER_DESTROY';\n  } else if (this._handshakeSequence && sequence.constructor === Sequences.Handshake) {\n    err      = new Error(prefixAfter + 'already enqueuing a Handshake.');\n    err.code = 'PROTOCOL_ENQUEUE_HANDSHAKE_TWICE';\n  } else if (!this._handshakeSequence && sequence.constructor === Sequences.ChangeUser) {\n    err      = new Error(prefixBefore + 'a Handshake.');\n    err.code = 'PROTOCOL_ENQUEUE_BEFORE_HANDSHAKE';\n  } else {\n    return true;\n  }\n\n  var self  = this;\n  err.fatal = false;\n\n  // add error handler\n  sequence.on('error', function (err) {\n    self._delegateError(err, sequence);\n  });\n\n  process.nextTick(function () {\n    sequence.end(err);\n  });\n\n  return false;\n};\n\nProtocol.prototype._parsePacket = function() {\n  var sequence = this._queue[0];\n\n  if (!sequence) {\n    var err   = new Error('Received packet with no active sequence.');\n    err.code  = 'PROTOCOL_STRAY_PACKET';\n    err.fatal = true;\n\n    this._delegateError(err);\n    return;\n  }\n\n  var Packet     = this._determinePacket(sequence);\n  var packet     = new Packet({protocol41: this._config.protocol41});\n  var packetName = Packet.name;\n\n  // Special case: Faster dispatch, and parsing done inside sequence\n  if (Packet === Packets.RowDataPacket) {\n    sequence.RowDataPacket(packet, this._parser, this._connection);\n\n    if (this._config.debug) {\n      this._debugPacket(true, packet);\n    }\n\n    return;\n  }\n\n  if (this._config.debug) {\n    this._parsePacketDebug(packet);\n  } else {\n    packet.parse(this._parser);\n  }\n\n  if (Packet === Packets.HandshakeInitializationPacket) {\n    this._handshakeInitializationPacket = packet;\n  }\n\n  Timers.active(sequence);\n\n  if (!sequence[packetName]) {\n    var err   = new Error('Received packet in the wrong sequence.');\n    err.code  = 'PROTOCOL_INCORRECT_PACKET_SEQUENCE';\n    err.fatal = true;\n\n    this._delegateError(err);\n    return;\n  }\n\n  sequence[packetName](packet);\n};\n\nProtocol.prototype._parsePacketDebug = function _parsePacketDebug(packet) {\n  try {\n    packet.parse(this._parser);\n  } finally {\n    this._debugPacket(true, packet);\n  }\n};\n\nProtocol.prototype._emitPacket = function(packet) {\n  var packetWriter = new PacketWriter();\n  packet.write(packetWriter);\n  this.emit('data', packetWriter.toBuffer(this._parser));\n\n  if (this._config.debug) {\n    this._debugPacket(false, packet);\n  }\n};\n\nProtocol.prototype._determinePacket = function(sequence) {\n  var firstByte = this._parser.peak();\n\n  if (sequence.determinePacket) {\n    var Packet = sequence.determinePacket(firstByte, this._parser);\n    if (Packet) {\n      return Packet;\n    }\n  }\n\n  switch (firstByte) {\n    case 0x00:\n      if (!this._handshaked) {\n        this._handshaked = true;\n        this.emit('handshake', this._handshakeInitializationPacket);\n      }\n      return Packets.OkPacket;\n    case 0xfe: return Packets.EofPacket;\n    case 0xff: return Packets.ErrorPacket;\n  }\n\n  throw new Error('Could not determine packet, firstByte = ' + firstByte);\n};\n\nProtocol.prototype._dequeue = function(sequence) {\n  Timers.unenroll(sequence);\n\n  // No point in advancing the queue, we are dead\n  if (this._fatalError) {\n    return;\n  }\n\n  this._queue.shift();\n\n  var sequence = this._queue[0];\n  if (!sequence) {\n    this.emit('drain');\n    return;\n  }\n\n  this._parser.resetPacketNumber();\n\n  this._startSequence(sequence);\n};\n\nProtocol.prototype._startSequence = function(sequence) {\n  if (sequence._timeout > 0 && isFinite(sequence._timeout)) {\n    Timers.enroll(sequence, sequence._timeout);\n    Timers.active(sequence);\n  }\n\n  if (sequence.constructor === Sequences.ChangeUser) {\n    sequence.start(this._handshakeInitializationPacket);\n  } else {\n    sequence.start();\n  }\n};\n\nProtocol.prototype.handleNetworkError = function(err) {\n  err.fatal = true;\n\n  var sequence = this._queue[0];\n  if (sequence) {\n    sequence.end(err);\n  } else {\n    this._delegateError(err);\n  }\n};\n\nProtocol.prototype.handleParserError = function handleParserError(err) {\n  var sequence = this._queue[0];\n  if (sequence) {\n    sequence.end(err);\n  } else {\n    this._delegateError(err);\n  }\n};\n\nProtocol.prototype._delegateError = function(err, sequence) {\n  // Stop delegating errors after the first fatal error\n  if (this._fatalError) {\n    return;\n  }\n\n  if (err.fatal) {\n    this._fatalError = err;\n  }\n\n  if (this._shouldErrorBubbleUp(err, sequence)) {\n    // Can't use regular 'error' event here as that always destroys the pipe\n    // between socket and protocol which is not what we want (unless the\n    // exception was fatal).\n    this.emit('unhandledError', err);\n  } else if (err.fatal) {\n    // Send fatal error to all sequences in the queue\n    var queue = this._queue;\n    process.nextTick(function () {\n      queue.forEach(function (sequence) {\n        sequence.end(err);\n      });\n      queue.length = 0;\n    });\n  }\n\n  // Make sure the stream we are piping to is getting closed\n  if (err.fatal) {\n    this.emit('end', err);\n  }\n};\n\nProtocol.prototype._shouldErrorBubbleUp = function(err, sequence) {\n  if (sequence) {\n    if (sequence.hasErrorHandler()) {\n      return false;\n    } else if (!err.fatal) {\n      return true;\n    }\n  }\n\n  return (err.fatal && !this._hasPendingErrorHandlers());\n};\n\nProtocol.prototype._hasPendingErrorHandlers = function() {\n  return this._queue.some(function(sequence) {\n    return sequence.hasErrorHandler();\n  });\n};\n\nProtocol.prototype.destroy = function() {\n  this._destroyed = true;\n  this._parser.pause();\n\n  if (this._connection.state !== \"disconnected\") {\n    if(!this._ended) {\n      this.end();\n    }\n  }\n};\n\nProtocol.prototype._debugPacket = function(incoming, packet) {\n  var headline = (incoming)\n    ? '<-- '\n    : '--> ';\n\n  headline = headline + packet.constructor.name;\n\n  // check for debug packet restriction\n  if (Array.isArray(this._config.debug) && this._config.debug.indexOf(packet.constructor.name) === -1) {\n    return;\n  }\n\n  console.log(headline);\n  console.log(packet);\n  console.log('');\n};\n"]}