{"version":3,"sources":["HandshakeInitializationPacket.js"],"names":[],"mappings":"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","file":"HandshakeInitializationPacket-compiled.js","sourcesContent":["var Client = require('../constants/client');\n\nmodule.exports = HandshakeInitializationPacket;\nfunction HandshakeInitializationPacket(options) {\n  options = options || {};\n\n  this.protocolVersion     = options.protocolVersion;\n  this.serverVersion       = options.serverVersion;\n  this.threadId            = options.threadId;\n  this.scrambleBuff1       = options.scrambleBuff1;\n  this.filler1             = options.filler1;\n  this.serverCapabilities1 = options.serverCapabilities1;\n  this.serverLanguage      = options.serverLanguage;\n  this.serverStatus        = options.serverStatus;\n  this.serverCapabilities2 = options.serverCapabilities2;\n  this.scrambleLength      = options.scrambleLength;\n  this.filler2             = options.filler2;\n  this.scrambleBuff2       = options.scrambleBuff2;\n  this.filler3             = options.filler3;\n  this.pluginData          = options.pluginData;\n  this.protocol41          = options.protocol41;\n\n  if (this.protocol41) {\n    // force set the bit in serverCapabilities1\n    this.serverCapabilities1 |= Client.CLIENT_PROTOCOL_41;\n  }\n}\n\nHandshakeInitializationPacket.prototype.parse = function(parser) {\n  this.protocolVersion     = parser.parseUnsignedNumber(1);\n  this.serverVersion       = parser.parseNullTerminatedString();\n  this.threadId            = parser.parseUnsignedNumber(4);\n  this.scrambleBuff1       = parser.parseBuffer(8);\n  this.filler1             = parser.parseFiller(1);\n  this.serverCapabilities1 = parser.parseUnsignedNumber(2);\n  this.serverLanguage      = parser.parseUnsignedNumber(1);\n  this.serverStatus        = parser.parseUnsignedNumber(2);\n\n  this.protocol41          = (this.serverCapabilities1 & (1 << 9)) > 0;\n\n  if (this.protocol41) {\n    this.serverCapabilities2 = parser.parseUnsignedNumber(2);\n    this.scrambleLength      = parser.parseUnsignedNumber(1);\n    this.filler2             = parser.parseFiller(10);\n    // scrambleBuff2 should be 0x00 terminated, but sphinx does not do this\n    // so we assume scrambleBuff2 to be 12 byte and treat the next byte as a\n    // filler byte.\n    this.scrambleBuff2       = parser.parseBuffer(12);\n    this.filler3             = parser.parseFiller(1);\n  } else {\n    this.filler2             = parser.parseFiller(13);\n  }\n\n  if (parser.reachedPacketEnd()) {\n    return;\n  }\n\n  // According to the docs this should be 0x00 terminated, but MariaDB does\n  // not do this, so we assume this string to be packet terminated.\n  this.pluginData = parser.parsePacketTerminatedString();\n\n  // However, if there is a trailing '\\0', strip it\n  var lastChar = this.pluginData.length - 1;\n  if (this.pluginData[lastChar] === '\\0') {\n    this.pluginData = this.pluginData.substr(0, lastChar);\n  }\n};\n\nHandshakeInitializationPacket.prototype.write = function(writer) {\n  writer.writeUnsignedNumber(1, this.protocolVersion);\n  writer.writeNullTerminatedString(this.serverVersion);\n  writer.writeUnsignedNumber(4, this.threadId);\n  writer.writeBuffer(this.scrambleBuff1);\n  writer.writeFiller(1);\n  writer.writeUnsignedNumber(2, this.serverCapabilities1);\n  writer.writeUnsignedNumber(1, this.serverLanguage);\n  writer.writeUnsignedNumber(2, this.serverStatus);\n  if (this.protocol41) {\n    writer.writeUnsignedNumber(2, this.serverCapabilities2);\n    writer.writeUnsignedNumber(1, this.scrambleLength);\n    writer.writeFiller(10);\n  }\n  writer.writeNullTerminatedBuffer(this.scrambleBuff2);\n\n  if (this.pluginData !== undefined) {\n    writer.writeNullTerminatedString(this.pluginData);\n  }\n};\n\nHandshakeInitializationPacket.prototype.scrambleBuff = function() {\n  var buffer = new Buffer(this.scrambleBuff1.length +\n                          (typeof this.scrambleBuff2 != \"undefined\" ? this.scrambleBuff2.length : 0));\n\n  this.scrambleBuff1.copy(buffer);\n  if (typeof this.scrambleBuff2 != \"undefined\") {\n    this.scrambleBuff2.copy(buffer, this.scrambleBuff1.length);\n  }\n\n  return buffer;\n};\n"]}